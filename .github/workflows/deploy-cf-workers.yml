name: Deploy Cloudflare Workers (Unified)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production
      action:
        description: 'Terraform Action'
        required: true
        default: 'apply'
        type: choice
        options:
          - plan
          - apply

env:
  NODE_VERSION: '20'
  TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  TF_VAR_cloudflare_account_id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  infrastructure:
    name: Infrastructure (${{ github.event.inputs.environment }})
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    outputs:
      s3_bucket: ${{ steps.tf_outputs.outputs.bucket_name }}
      s3_cdn_url: ${{ steps.tf_outputs.outputs.s3_cdn_url }}
      s3_endpoint: ${{ steps.tf_outputs.outputs.s3_endpoint }}
      workers_name: ${{ steps.tf_outputs.outputs.workers_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      - name: Terraform Init
        working-directory: infrastructure
        run: terraform init

      - name: Terraform Format Check
        working-directory: infrastructure
        run: terraform fmt -check

      - name: Terraform Validate
        working-directory: infrastructure
        run: terraform validate

      - name: Terraform Plan
        if: github.event.inputs.action == 'plan' || github.event.inputs.action == 'apply'
        working-directory: infrastructure
        run: terraform plan -no-color

      - name: Import existing R2 bucket if it exists
        if: github.event.inputs.action == 'apply'
        working-directory: infrastructure
        continue-on-error: true
        run: |
          # Try to import the production bucket if it exists
          # Format: account_id/bucket_name/jurisdiction (jurisdiction defaults to 'default')
          echo "Attempting to import existing bucket: cloudflare-image-mcp-images"
          terraform import cloudflare_r2_bucket.images ${{ secrets.CLOUDFLARE_ACCOUNT_ID}}/cloudflare-image-mcp-images/default 2>&1 || echo "Bucket not found or already imported, will create new"

      - name: Terraform Apply
        if: github.event.inputs.action == 'apply'
        working-directory: infrastructure
        run: terraform apply -auto-approve -no-color

      - name: Capture Terraform Outputs
        if: github.event.inputs.action == 'apply'
        working-directory: infrastructure
        id: tf_outputs
        run: |
          echo "s3_cdn_url=$(terraform output -raw s3_cdn_url)" >> $GITHUB_OUTPUT
          echo "bucket_name=$(terraform output -raw bucket_name)" >> $GITHUB_OUTPUT
          echo "s3_endpoint=$(terraform output -raw s3_endpoint)" >> $GITHUB_OUTPUT
          echo "workers_name=$(terraform output -raw workers_name)" >> $GITHUB_OUTPUT

      - name: Output Summary
        if: github.event.inputs.action == 'apply'
        run: |
          echo "## Infrastructure Deployed" >> $GITHUB_STEP_SUMMARY
          echo "**Bucket:** ${{ steps.tf_outputs.outputs.bucket_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**CDN URL:** ${{ steps.tf_outputs.outputs.s3_cdn_url }}" >> $GITHUB_STEP_SUMMARY

  workers:
    name: Workers (${{ github.event.inputs.environment }})
    runs-on: ubuntu-latest
    needs: infrastructure
    if: github.event.inputs.action == 'apply'
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: workers/package-lock.json

      - name: Install dependencies
        working-directory: workers
        run: npm ci

      - name: Type check
        working-directory: workers
        run: npm run check

      - name: Set environment variables
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment }}"
          echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV
          if [ "$ENVIRONMENT" == "staging" ]; then
            echo "WORKERS_NAME=cloudflare-image-workers-staging" >> $GITHUB_ENV
          else
            echo "WORKERS_NAME=cloudflare-image-workers" >> $GITHUB_ENV
          fi

      - name: Check R2 API credentials
        run: |
          if [ -z "${{ secrets.S3_ACCESS_KEY }}" ] || [ -z "${{ secrets.S3_SECRET_KEY }}" ]; then
            echo "⚠️ WARNING: S3_ACCESS_KEY or S3_SECRET_KEY not set"
            echo "Please create R2 API tokens in Cloudflare Dashboard > R2 > Manage API Tokens"
            echo "Or set them as repository secrets."
          else
            echo "✅ R2 API credentials configured"
          fi

      - name: Generate wrangler.toml
        working-directory: workers
        run: |
          cat > wrangler.toml << EOF
          name = "${{ env.WORKERS_NAME }}"
          account_id = "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
          compatibility_date = "2025-01-01"
          main = "src/index.ts"

          [[r2_buckets]]
          binding = "IMAGE_BUCKET"
          bucket_name = "${{ needs.infrastructure.outputs.s3_bucket }}"

          [ai]
          binding = "AI"
          account_id = "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"

          [vars]
          IMAGE_EXPIRY_HOURS = "24"
          BUCKET_NAME = "${{ needs.infrastructure.outputs.s3_bucket }}"
          EOF

          echo "✅ wrangler.toml generated with bucket: ${{ needs.infrastructure.outputs.s3_bucket }}"

      - name: Set deployment metadata
        working-directory: workers
        run: |
          echo "DEPLOYED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_ENV
          echo "COMMIT_SHA=${{ github.sha }}" >> $GITHUB_ENV

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers
          command: deploy
        env:
          S3_CDN_URL: ${{ needs.infrastructure.outputs.s3_cdn_url }}
          API_KEYS: ${{ secrets.API_KEYS }}

      - name: Set secrets
        working-directory: workers
        run: |
          echo "${{ env.DEPLOYED_AT }}" | npx wrangler secret put DEPLOYED_AT --name ${{ env.WORKERS_NAME }}
          echo "${{ github.sha }}" | npx wrangler secret put COMMIT_SHA --name ${{ env.WORKERS_NAME }}
          echo "${{ needs.infrastructure.outputs.s3_cdn_url }}" | npx wrangler secret put S3_CDN_URL --name ${{ env.WORKERS_NAME }}
          if [ -n "${{ secrets.API_KEYS }}" ]; then
            echo "${{ secrets.API_KEYS }}" | npx wrangler secret put API_KEYS --name ${{ env.WORKERS_NAME }}
          fi
          if [ -n "${{ secrets.DEFAULT_MODEL }}" ]; then
            echo "${{ secrets.DEFAULT_MODEL }}" | npx wrangler secret put DEFAULT_MODEL --name ${{ env.WORKERS_NAME }}
          fi
          if [ -n "${{ secrets.TZ }}" ]; then
            echo "${{ secrets.TZ }}" | npx wrangler secret put TZ --name ${{ env.WORKERS_NAME }}
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Cleanup sensitive files
        if: always()
        working-directory: workers
        run: rm -f wrangler.toml

      - name: Deployment summary
        run: |
          WORKERS_URL="https://${{ env.WORKERS_NAME }}.${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.workers.dev"
          echo "## ✅ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workers URL:** $WORKERS_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Bucket:** ${{ needs.infrastructure.outputs.s3_bucket }}" >> $GITHUB_STEP_SUMMARY
