name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      action:
        description: 'Terraform Action'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy

env:
  TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  TF_VAR_cloudflare_account_id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  TF_VAR_environment: ${{ github.event.inputs.environment }}

jobs:
  terraform:
    name: Terraform (${{ github.event.inputs.environment }})
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      - name: Terraform Init
        working-directory: infrastructure
        run: terraform init

      - name: Terraform Format Check
        working-directory: infrastructure
        run: terraform fmt -check

      - name: Terraform Validate
        working-directory: infrastructure
        run: terraform validate

      - name: Terraform Plan
        if: github.event.inputs.action == 'plan' || github.event.inputs.action == 'apply'
        working-directory: infrastructure
        run: terraform plan -no-color

      - name: Terraform Apply
        if: github.event.inputs.action == 'apply'
        working-directory: infrastructure
        run: terraform apply -auto-approve -no-color

      - name: Capture Terraform Outputs
        if: github.event.inputs.action == 'apply'
        working-directory: infrastructure
        id: tf_outputs
        run: |
          echo "s3_cdn_url=$(terraform output -raw s3_cdn_url)" >> $GITHUB_OUTPUT
          echo "bucket_name=$(terraform output -raw bucket_name)" >> $GITHUB_OUTPUT
          echo "s3_endpoint=$(terraform output -raw s3_endpoint)" >> $GITHUB_OUTPUT
          echo "workers_name=$(terraform output -raw workers_name)" >> $GITHUB_OUTPUT

      - name: Construct Workers URL
        if: github.event.inputs.action == 'apply'
        run: |
          WORKERS_NAME="${{ steps.tf_outputs.outputs.workers_name }}"
          WORKERS_URL="https://${WORKERS_NAME}.${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.workers.dev"
          echo "WORKERS_URL=$WORKERS_URL" >> $GITHUB_OUTPUT
          echo "Workers URL: $WORKERS_URL"

      - name: Update GitHub Environment Secrets
        if: github.event.inputs.action == 'apply'
        uses: actions/github-script@v7
        with:
          script: |
            const environment = '${{ github.event.inputs.environment }}';
            const s3CdnUrl = '${{ steps.tf_outputs.outputs.s3_cdn_url }}';
            const bucketName = '${{ steps.tf_outputs.outputs.bucket_name }}';
            const s3Endpoint = '${{ steps.tf_outputs.outputs.s3_endpoint }}';
            const workersName = '${{ steps.tf_outputs.outputs.workers_name }}';

            // Get the environment ID
            const { data: envs } = await github.rest.repos.getAllEnvironments({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            let envId = envs.environments.find(e => e.name === environment)?.id;

            // Create environment if it doesn't exist
            if (!envId) {
              console.log(`Creating environment: ${environment}`);
              const { data: newEnv } = await github.rest.repos.createOrUpdateEnvironment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                environment_name: environment,
              });
              envId = newEnv.id;
            }

            // Create/update secrets (WORKERS_URL is constructed from account ID, not stored)
            const secrets = {
              'S3_CDN_URL': s3CdnUrl,
              'S3_BUCKET': bucketName,
              'S3_ENDPOINT': s3Endpoint,
            };

            // Get public key for encryption
            const { data: publicKey } = await github.rest.actions.getEnvironmentPublicKey({
              owner: context.repo.owner,
              repo: context.repo.repo,
              environment_name: environment,
            });

            for (const [name, value] of Object.entries(secrets)) {
              if (!value) {
                console.log(`Skipping ${name} - no value`);
                continue;
              }

              // Encrypt the secret using libsodium
              const sodium = require('libsodium-wrappers');
              await sodium.ready;
              const encryptedBytes = sodium.crypto_box_seal(
                Buffer.from(value),
                Buffer.from(publicKey.key, 'base64')
              );
              const encryptedValue = Buffer.from(encryptedBytes).toString('base64');

              await github.rest.actions.createOrUpdateEnvironmentSecret({
                owner: context.repo.owner,
                repo: context.repo.repo,
                environment_name: environment,
                secret_name: name,
                encrypted_value: encryptedValue,
                key_id: publicKey.key_id,
              });

              console.log(`Updated secret: ${name}`);
            }

            console.log(`âœ… Environment secrets updated for ${environment}`);

      - name: Output Summary
        if: github.event.inputs.action == 'apply'
        run: |
          echo "## Infrastructure Deployed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**S3_CDN_URL:** ${{ steps.tf_outputs.outputs.s3_cdn_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Bucket Name:** ${{ steps.tf_outputs.outputs.bucket_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**S3 Endpoint:** ${{ steps.tf_outputs.outputs.s3_endpoint }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workers Name:** ${{ steps.tf_outputs.outputs.workers_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workers URL:** https://${{ steps.tf_outputs.outputs.workers_name }}.${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.workers.dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Secrets Updated" >> $GITHUB_STEP_SUMMARY
          echo "- S3_CDN_URL, S3_BUCKET, S3_ENDPOINT in GitHub Environment: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Notes" >> $GITHUB_STEP_SUMMARY
          echo "- Workers URL is constructed from account ID: \`https://<workers-name>.<account-id>.workers.dev\`" >> $GITHUB_STEP_SUMMARY
          echo "- No need to store WORKERS_URL as a separate secret" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Deploy the Workers to ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "2. Run E2E tests against ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY

      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        working-directory: infrastructure
        run: terraform destroy -auto-approve -no-color
