name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
    paths:
      - 'workers/**'
      - '.github/workflows/deploy-workers.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    name: Deploy Workers (${{ github.event.inputs.environment || 'production' }})
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: workers/package-lock.json

      - name: Install dependencies
        working-directory: workers
        run: npm ci

      - name: Type check
        working-directory: workers
        run: npm run check

      - name: Verify secrets are configured
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "❌ ERROR: CLOUDFLARE_API_TOKEN secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ]; then
            echo "❌ ERROR: CLOUDFLARE_ACCOUNT_ID secret is not set"
            exit 1
          fi
          echo "✅ Required secrets are configured"

      - name: Set environment variables
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment || 'production' }}"
          echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV

          # Determine worker name based on environment
          if [ "$ENVIRONMENT" == "staging" ]; then
            echo "WORKERS_NAME=cloudflare-image-workers-staging" >> $GITHUB_ENV
          else
            echo "WORKERS_NAME=cloudflare-image-workers" >> $GITHUB_ENV
          fi

          echo "Deploying to $ENVIRONMENT as ${{ env.WORKERS_NAME }}"

      - name: Create wrangler.toml from template
        working-directory: workers
        run: |
          # Copy template and inject secrets
          if [ -f wrangler.toml.example ]; then
            cp wrangler.toml.example wrangler.toml
          else
            echo "Error: wrangler.toml.example not found"
            exit 1
          fi

          # Update account_id in wrangler.toml
          sed -i "s/account_id = \"\"/account_id = \"${{ secrets.CLOUDFLARE_ACCOUNT_ID }}\"/" wrangler.toml

          # Update account_id under [ai] section if it exists
          if grep -q "\[ai\]" wrangler.toml; then
            sed -i "/\[ai\]/,/\[/{s/account_id = \"\"/account_id = \"${{ secrets.CLOUDFLARE_ACCOUNT_ID }}\"/}" wrangler.toml || true
          fi

          # Update worker name based on environment
          if [ "${{ env.ENVIRONMENT }}" == "staging" ]; then
            sed -i "s/name = \"cloudflare-image-workers\"/name = \"cloudflare-image-workers-staging\"/" wrangler.toml
          fi

          # Note: S3_CDN_URL should be set as a secret via wrangler secret put
          # Terraform will output the S3_CDN_URL after infrastructure deployment

          # Verify wrangler.toml was created
          if [ ! -f wrangler.toml ]; then
            echo "Error: Failed to create wrangler.toml"
            exit 1
          fi

          echo "✅ wrangler.toml created successfully"
          cat wrangler.toml

      - name: Set deployment metadata
        working-directory: workers
        run: |
          # Set deployment timestamp and commit SHA
          echo "DEPLOYED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_ENV
          echo "COMMIT_SHA=${{ github.sha }}" >> $GITHUB_ENV

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers
          command: deploy --env ${{ env.ENVIRONMENT }}
        env:
          S3_CDN_URL: ${{ secrets.S3_CDN_URL }}
          API_KEYS: ${{ secrets.API_KEYS }}

      - name: Set deployment metadata secrets
        working-directory: workers
        run: |
          # Set deployment metadata as secrets for visibility
          echo "${{ env.DEPLOYED_AT }}" | npx wrangler secret put DEPLOYED_AT --name ${{ env.WORKERS_NAME }}
          echo "${{ github.sha }}" | npx wrangler secret put COMMIT_SHA --name ${{ env.WORKERS_NAME }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Update deployment status
        uses: actions/github-script@v7
        with:
          script: |
            const environment = '${{ env.ENVIRONMENT }}';
            const workersUrl = '${{ secrets.WORKERS_URL }}';

            if (workersUrl) {
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: context.payload.deployment?.id,
                state: 'success',
                environment_url: workersUrl,
                log_url: `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
              });
            }

      - name: Construct Workers URL
        run: |
          WORKERS_URL="https://${{ env.WORKERS_NAME }}.${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.workers.dev"
          echo "WORKERS_URL=$WORKERS_URL" >> $GITHUB_ENV
          echo "Workers URL: $WORKERS_URL"

      - name: Deployment summary
        if: success()
        run: |
          echo "## ✅ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Worker Name:** ${{ env.WORKERS_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workers URL:** ${{ env.WORKERS_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Endpoints Available" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ env.WORKERS_URL }}/" >> $GITHUB_STEP_SUMMARY
          echo "- OpenAI API: ${{ env.WORKERS_URL }}/v1/images/generations" >> $GITHUB_STEP_SUMMARY
          echo "- MCP HTTP: ${{ env.WORKERS_URL }}/mcp" >> $GITHUB_STEP_SUMMARY
          echo "- MCP SSE: ${{ env.WORKERS_URL }}/mcp?transport=sse" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Secrets Configured" >> $GITHUB_STEP_SUMMARY
          echo "- S3_CDN_URL: ${{ secrets.S3_CDN_URL != '' && '✅ Configured' || '❌ Missing' }}" >> $GITHUB_STEP_SUMMARY
          echo "- API_KEYS: ${{ secrets.API_KEYS != '' && '✅ Configured' || '❌ Missing' }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "## ❌ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
